<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book a Test | Healthify Lab</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="header fixed">
    <div class="logo">
      <img src="public/logo.png" alt="Healthify Logo" />
      <span>Healthify Lab</span>
    </div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="booking.html" class="active">Book Test</a>
    </nav>
  </header>

  <section class="booking-form">
    <h2>ðŸ“‹ Book Your Test</h2>
    <form id="bookingForm">
      <label>Name:
        <input type="text" name="name" required />
      </label>
      <label>Mobile:
        <input type="tel" name="mobile" required />
      </label>
      <label>Email (optional):
        <input type="email" name="email" />
      </label>
      <label>Preferred Date:
        <input type="date" name="preferredDate" required />
      </label>
      <label>Address:
        <textarea name="address" required></textarea>
      </label>
      <label>Pincode:
        <input type="text" name="pincode" required />
      </label>
      <label>Landmark:
        <input type="text" name="landmark" />
      </label>

      <label>Select Tests:
        <select id="testSelect" name="testSelect" multiple size="5"></select>
      </label>

      <label>Select Profiles:
        <select id="profileSelect" name="profileSelect" multiple size="5"></select>
      </label>

      <button type="submit">ðŸ“¨ Submit Booking</button>
    </form>

    <div id="cartSummary">
      <h3>ðŸ›’ Your Cart</h3>
      <ul id="cartList"></ul>
      <p>
        <strong>Total Offer Price: â‚¹<span id="totalPrice">0</span></strong><br/>
        <strong>Total MRP: â‚¹<span id="totalMRP">0</span></strong><br/>
        <strong>You Save: â‚¹<span id="totalSaving">0</span> (<span id="totalDiscount">0</span>%)</strong>
      </p>
    </div>
  </section>

  <!-- Modular Firebase + EmailJS -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    import emailjs from 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.browser.min.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDS-MJYzAB2EDNY7Hhy2RtdEkxflj2jI-A",
      authDomain: "healthify-lab.firebaseapp.com",
      projectId: "healthify-lab",
      storageBucket: "healthify-lab.firebasestorage.app",
      messagingSenderId: "297003315332",
      appId: "1:297003315332:web:49f6ed6fc61cce4a74d2d1"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    emailjs.init('dJE_JHAoNTxxzTxiT');

    let tests = [], profiles = [];

    // Load JSON data
    async function loadOptions() {
      try {
        const [tRes, pRes] = await Promise.all([
          fetch('/data/tests.json'),
          fetch('/data/profiles.json')
        ]);
        if (!tRes.ok || !pRes.ok) throw new Error('Data fetch failed');
        tests = await tRes.json();
        profiles = await pRes.json();
      } catch (e) {
        alert('Error loading tests/profiles: ' + e.message);
        return;
      }

      const tSel = document.getElementById('testSelect');
      const pSel = document.getElementById('profileSelect');
      tSel.innerHTML = pSel.innerHTML = '';

      tests.forEach(t => {
        const o = new Option(`${t.name} (Offer: â‚¹${t.offerPrice}, MRP: â‚¹${t.mrp})`, t.name);
        tSel.add(o);
      });
      profiles.forEach(p => {
        const o = new Option(`${p.name} (Offer: â‚¹${p.offerPrice}, MRP: â‚¹${p.mrp})`, p.name);
        pSel.add(o);
      });

      updateCart();
    }

    // Update cart
    function updateCart() {
      const tSel = document.getElementById('testSelect');
      const pSel = document.getElementById('profileSelect');
      const list = document.getElementById('cartList');
      let totalOffer = 0, totalMRP = 0;
      list.innerHTML = '';

      [...tSel.selectedOptions].forEach(opt => {
        const t = tests.find(x => x.name === opt.value);
        const save = t.mrp - t.offerPrice;
        const disc = Math.round((save / t.mrp) * 100);
        list.innerHTML += `<li>ðŸ§ª ${t.name} â€” MRP: â‚¹${t.mrp}, Offer: â‚¹${t.offerPrice}, Save: ${disc}%</li>`;
        totalOffer += t.offerPrice; totalMRP += t.mrp;
      });
      [...pSel.selectedOptions].forEach(opt => {
        const p = profiles.find(x => x.name === opt.value);
        const save = p.mrp - p.offerPrice;
        const disc = Math.round((save / p.mrp) * 100);
        list.innerHTML += `<li>ðŸ“¦ ${p.name} â€” MRP: â‚¹${p.mrp}, Offer: â‚¹${p.offerPrice}, Save: ${disc}%</li>`;
        totalOffer += p.offerPrice; totalMRP += p.mrp;
      });

      const saving = totalMRP - totalOffer;
      const discount = totalMRP ? Math.round((saving / totalMRP) * 100) : 0;
      document.getElementById('totalPrice').textContent = totalOffer;
      document.getElementById('totalMRP').textContent = totalMRP;
      document.getElementById('totalSaving').textContent = saving;
      document.getElementById('totalDiscount').textContent = discount;
    }

    // Form submission
    document.getElementById('bookingForm').addEventListener('submit', async e => {
      e.preventDefault();
      const f = e.target;
      const data = {
        name: f.name.value,
        mobile: f.mobile.value,
        email: f.email.value || null,
        preferredDate: f.preferredDate.value,
        address: f.address.value,
        pincode: f.pincode.value,
        landmark: f.landmark.value,
        tests: [...f.testSelect.selectedOptions].map(o => o.value),
        profiles: [...f.profileSelect.selectedOptions].map(o => o.value),
        timestamp: new Date().toISOString()
      };

      try {
        await addDoc(collection(db, 'bookings'), data);
        if (data.email) await emailjs.send('service_z3ac4pk', 'template_5v6t6ku', data);
        alert('âœ… Booking submitted!');
        f.reset(); updateCart();
      } catch (e) {
        alert('Failed to submit booking: ' + e.message);
      }
    });

    window.addEventListener('DOMContentLoaded', loadOptions);
  </script>
</body>
</html>
