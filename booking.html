<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book a Test | Healthify Lab</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="firebase.js"></script>
</head>
<body>
  <header class="header fixed">
    <div class="logo">
      <img src="public/logo.png" alt="Healthify Logo" />
      <span>Healthify Lab</span>
    </div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="booking.html" class="active">Book Test</a>
    </nav>
  </header>

  <section class="booking-form">
    <h2>ðŸ“‹ Book Your Test</h2>

    <form id="bookingForm">
      <label>Name:
        <input type="text" name="name" required />
      </label>

      <label>Mobile:
        <input type="tel" name="mobile" required />
      </label>

      <label>Email:
        <input type="email" name="email" required />
      </label>

      <label>Preferred Date:
        <input type="date" name="preferredDate" required />
      </label>

      <label>Address:
        <textarea name="address" required></textarea>
      </label>

      <label>Pincode:
        <input type="text" name="pincode" required />
      </label>

      <label>Landmark:
        <input type="text" name="landmark" />
      </label>

      <label>Select Tests:
        <select id="testSelect" multiple></select>
      </label>

      <label>Select Profiles:
        <select id="profileSelect" multiple></select>
      </label>

      <button type="submit">ðŸ“¨ Submit Booking</button>
    </form>

    <div id="cartSummary">
      <h3>ðŸ›’ Your Cart</h3>
      <ul id="cartList"></ul>
      <p><strong>Total: â‚¹<span id="totalPrice">0</span></strong></p>
    </div>
  </section>

  <script>
    let tests = [], profiles = [];

    async function loadOptions() {
      const testRes = await fetch("data/tests.json");
      const profileRes = await fetch("data/profiles.json");
      tests = await testRes.json();
      profiles = await profileRes.json();

      const testSelect = document.getElementById("testSelect");
      const profileSelect = document.getElementById("profileSelect");

      tests.forEach(test => {
        const opt = document.createElement("option");
        opt.value = test.name;
        opt.textContent = `${test.name} (â‚¹${test.offerPrice})`;
        testSelect.appendChild(opt);
      });

      profiles.forEach(profile => {
        const opt = document.createElement("option");
        opt.value = profile.name;
        opt.textContent = `${profile.name} (â‚¹${profile.offerPrice})`;
        profileSelect.appendChild(opt);
      });
    }

    function updateCart() {
      const selectedTests = Array.from(document.getElementById("testSelect").selectedOptions).map(opt => opt.value);
      const selectedProfiles = Array.from(document.getElementById("profileSelect").selectedOptions).map(opt => opt.value);

      const cartList = document.getElementById("cartList");
      const totalSpan = document.getElementById("totalPrice");
      cartList.innerHTML = "";
      let total = 0;

      selectedTests.forEach(testName => {
        const test = tests.find(t => t.name === testName);
        if (test) {
          const li = document.createElement("li");
          li.textContent = `ðŸ§ª ${test.name} - â‚¹${test.offerPrice}`;
          cartList.appendChild(li);
          total += test.offerPrice;
        }
      });

      selectedProfiles.forEach(profileName => {
        const profile = profiles.find(p => p.name === profileName);
        if (profile) {
          const li = document.createElement("li");
          li.textContent = `ðŸ“¦ ${profile.name} - â‚¹${profile.offerPrice}`;
          cartList.appendChild(li);
          total += profile.offerPrice;
        }
      });

      totalSpan.textContent = total;
    }

    document.getElementById("testSelect").addEventListener("change", updateCart);
    document.getElementById("profileSelect").addEventListener("change", updateCart);

    document.getElementById("bookingForm").addEventListener("submit", async e => {
      e.preventDefault();

      const form = e.target;
      const data = {
        name: form.name.value,
        mobile: form.mobile.value,
        email: form.email.value,
        preferredDate: form.preferredDate.value,
        address: form.address.value,
        pincode: form.pincode.value,
        landmark: form.landmark.value,
        tests: Array.from(document.getElementById("testSelect").selectedOptions).map(opt => opt.value),
        profiles: Array.from(document.getElementById("profileSelect").selectedOptions).map(opt => opt.value),
        timestamp: new Date().toISOString(),
      };

      // Save to Firebase (assumes firebase.js initializes Firestore)
      const db = window.firestore;
      await db.collection("bookings").add(data);

      // Send EmailJS confirmation
      emailjs.send("service_z3ac4pk", "template_5v6t6ku", data, "dJE_JHAoNTxxzTxiT");

      alert("âœ… Booking Submitted! You'll receive confirmation shortly.");
      form.reset();
      document.getElementById("cartList").innerHTML = "";
      document.getElementById("totalPrice").textContent = "0";
    });

    loadOptions();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <script>
    emailjs.init("dJE_JHAoNTxxzTxiT");
  </script>
</body>
</html>
