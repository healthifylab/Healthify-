<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book a Test | Healthify Lab</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="firebase.js"></script>
</head>
<body>
  <header class="header fixed">
    <div class="logo">
      <img src="public/logo.png" alt="Healthify Logo" />
      <span>Healthify Lab</span>
    </div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="booking.html" class="active">Book Test</a>
    </nav>
  </header>

  <section class="booking-form">
    <h2>ğŸ“‹ Book Your Test</h2>
    <form id="bookingForm">
      <label>Name:
        <input type="text" name="name" required />
      </label>
      <label>Mobile:
        <input type="tel" name="mobile" required />
      </label>
      <label>Email:
        <input type="email" name="email" placeholder="(Optional)" />
      </label>
      <label>Preferred Date:
        <input type="date" name="preferredDate" required />
      </label>
      <label>Address:
        <textarea name="address" required></textarea>
      </label>
      <label>Pincode:
        <input type="text" name="pincode" required />
      </label>
      <label>Landmark:
        <input type="text" name="landmark" />
      </label>

      <label>Select Tests:
        <select id="testSelect" name="testSelect" multiple size="5"></select>
      </label>

      <label>Select Profiles:
        <select id="profileSelect" name="profileSelect" multiple size="5"></select>
      </label>

      <button type="submit">ğŸ“¨ Submit Booking</button>
    </form>

    <div id="cartSummary">
      <h3>ğŸ›’ Your Cart</h3>
      <ul id="cartList"></ul>
      <p>
        <strong>Total Offer Price: â‚¹<span id="totalPrice">0</span></strong><br/>
        <strong>Total MRP: â‚¹<span id="totalMRP">0</span></strong><br/>
        <strong>You Save: â‚¹<span id="totalSaving">0</span> (<span id="totalDiscount">0</span>%)</strong>
      </p>
    </div>

    <section style="background:#fee;padding:10px;margin-top:20px;border:1px solid #f00;">
      <h3>Debug Log</h3>
      <pre id="logOutput" style="white-space:pre-wrap;font-size:12px;"></pre>
    </section>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <script>
    emailjs.init("dJE_JHAoNTxxzTxiT");

    let tests = [], profiles = [];

    function log(msg) {
      console.log("[DEBUG]", msg);
      const out = document.getElementById('logOutput');
      out.textContent += msg + '\n';
    }

    async function loadOptions() {
      try {
        log('Fetching test/profile data...');
        const [testRes, profileRes] = await Promise.all([
          fetch("/data/tests.json"),
          fetch("/data/profiles.json")
        ]);
        log(`tests.json: ${testRes.status}, profiles.json: ${profileRes.status}`);
        tests = await testRes.json();
        profiles = await profileRes.json();
        log(`Loaded ${tests.length} tests and ${profiles.length} profiles`);
      } catch (err) {
        log('âŒ Failed loading data: ' + err.message);
        alert("Failed to load test data.");
        return;
      }

      const tSel = document.getElementById("testSelect");
      const pSel = document.getElementById("profileSelect");
      tSel.innerHTML = "";
      pSel.innerHTML = "";

      tests.forEach(t => {
        const o = document.createElement("option");
        o.value = t.name;
        o.text  = `${t.name} (â‚¹${t.offerPrice} / MRP â‚¹${t.mrp})`;
        tSel.appendChild(o);
      });

      profiles.forEach(p => {
        const o = document.createElement("option");
        o.value = p.name;
        o.text  = `${p.name} (â‚¹${p.offerPrice} / MRP â‚¹${p.mrp})`;
        pSel.appendChild(o);
      });

      updateCart();
    }

    function updateCart() {
      const tSel = document.getElementById("testSelect");
      const pSel = document.getElementById("profileSelect");
      const cartList = document.getElementById("cartList");
      let totalOffer = 0, totalMRP = 0;
      cartList.innerHTML = "";

      Array.from(tSel.selectedOptions).forEach(opt => {
        const t = tests.find(x => x.name === opt.value);
        if (t) {
          const saving = t.mrp - t.offerPrice;
          const discount = Math.round((saving / t.mrp) * 100);
          cartList.innerHTML += `<li>ğŸ§ª ${t.name} â€” â‚¹${t.offerPrice} <span style="color:#888;">(MRP â‚¹${t.mrp}, Save ${discount}%)</span></li>`;
          totalOffer += t.offerPrice;
          totalMRP   += t.mrp;
        }
      });

      Array.from(pSel.selectedOptions).forEach(opt => {
        const p = profiles.find(x => x.name === opt.value);
        if (p) {
          const saving = p.mrp - p.offerPrice;
          const discount = Math.round((saving / p.mrp) * 100);
          cartList.innerHTML += `<li>ğŸ“¦ ${p.name} â€” â‚¹${p.offerPrice} <span style="color:#888;">(MRP â‚¹${p.mrp}, Save ${discount}%)</span></li>`;
          totalOffer += p.offerPrice;
          totalMRP   += p.mrp;
        }
      });

      const totalSaving = totalMRP - totalOffer;
      const totalDiscount = totalMRP ? Math.round((totalSaving / totalMRP) * 100) : 0;

      document.getElementById("totalPrice").textContent     = totalOffer;
      document.getElementById("totalMRP").textContent       = totalMRP;
      document.getElementById("totalSaving").textContent    = totalSaving;
      document.getElementById("totalDiscount").textContent  = totalDiscount;
    }

    document.getElementById("testSelect").addEventListener("change", updateCart);
    document.getElementById("profileSelect").addEventListener("change", updateCart);

    document.getElementById("bookingForm").addEventListener("submit", async e => {
      e.preventDefault();
      const f = e.target;
      const data = {
        name:          f.name.value,
        mobile:        f.mobile.value,
        email:         f.email.value || "Not Provided",
        preferredDate: f.preferredDate.value,
        address:       f.address.value,
        pincode:       f.pincode.value,
        landmark:      f.landmark.value,
        tests:         Array.from(f.testSelect.selectedOptions).map(o => o.value),
        profiles:      Array.from(f.profileSelect.selectedOptions).map(o => o.value),
        timestamp:     new Date().toISOString()
      };

      try {
        log("â³ Submitting booking...");
        await window.firestore.addBooking(data);
        log("âœ… Saved to Firestore");
        await emailjs.send("service_z3ac4pk", "template_5v6t6ku", data);
        log("ğŸ“§ Email sent via EmailJS");
        alert("âœ… Booking submitted successfully!");
        f.reset();
        updateCart();
      } catch (err) {
        log("âŒ Booking failed: " + err.message);
        alert("âŒ Failed to submit booking. Please try again.");
      }
    });

    window.addEventListener("DOMContentLoaded", loadOptions);
  </script>
</body>
</html>
